# Create directories
mkdir -p software/ output/

# Get postgres source
wget -P software/ https://ftp.postgresql.org/pub/source/v9.2.0/postgresql-9.2.0.tar.gz

# Extract postgres source and compile
tar -zxvf software/postgresql-9.2.0.tar.gz -C software/ && cd software/postgresql-9.2.0/
./configure --prefix=$(pwd -P)/../ --disable-float8-byval
make -j4 && make install
cd ../../

# Allow password-less auth on vitek database
sed -i '/^host / { s/md5\r/trust/ }' data_801/pg_hba.conf

# Run postgres server for the vitek database
./software/bin/postgres -D data_801/ -h localhost -p 50808

# Dump MICs and cast to a wide format
./software/bin/psql -U postgres -h localhost -p 50808 -f scripts/export_mics.sql | tail -n+2 > output/vitek_mics_export.csv
./scripts/cast_data.R output/vitek_mics_export.csv output/vitek_mics_export_wide.csv
